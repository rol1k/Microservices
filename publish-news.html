<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Отправить новость</title>

	<!-- Bootstrap -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
</head>
<body>
	<nav class="navbar navbar-default">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="navbar-collapse">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
				<a class="navbar-brand" href="#">Микросервисы</a>
			</div>

			<div class="collapse navbar-collapse" id="navbar-collapse">
				<ul class="nav navbar-nav">
					<li><a href="read-news.html">Читать новости</a></li>
					<li class="active"><a href="publish-news.html">Опубликовать новость</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<h1 class="text-center">Опубликовать новость</h1>
			</div>
		</div>
	</div>

	<div class="container">
		<div class="row">
			<div class="col-xs-12">
				<div id="alert-success" class="alert alert-success">
					<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					<span id="message-body-success">Успех!</span>
				</div>
				<div id="alert-danger" class="alert alert-danger">
					<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
					<span id="message-body-danger">Фиаско!</span>
				</div>
			</div>
		</div>
	</div>

	<div class="container">
		<form>
			<div class="form-group">
				<label class="control-label" for="topic">Рубрика</label>
				<select class="form-control" id="topic" required>
					<option value="Автомобили">Автомобили</option>
					<option value="Электроника">Электроника</option>
					<option value="Медицина">Медицина</option>
				</select>
			</div>
			<div class="form-group">
				<label class="control-label" for="news">Новость</label>
				<textarea class="form-control" id="news" placeholder="Напишите новость" rows="3" required></textarea>
			</div>
			<div class="form-group">
				<button id="publish" type="button" class="btn btn-primary">Опубликовать</button>
			</div>
		</form>
	</div>


	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
	<!-- Bootstrap -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

	<script>
		$(".alert").alert();
		$("#message-body-success").html('Новость опубликована!');
		$("#message-body-danger").html('Новость не прошла модерацию!');

		var conTopology, conn, connList, topologyAddress = '127.0.0.1:8090';

		setTopologyConnection(topologyAddress);

		function setTopologyConnection(address) {
			conTopology = new WebSocket('ws://'+address);
			conTopology.onopen = function(e) {
				console.log("Установленно соединение с topology " + address);
				conTopology.send('getlistnode|'+JSON.stringify('RATCHET RECEIVE WS'));
			};

			conTopology.onmessage = function(e) {
				var msg = e.data;
				msg = msg.split('|');
				msg[1] = JSON.parse(msg[1]);
				if('getlistnode' == msg[0] && 0 < msg[1].length) {
					var address = msg[1][Math.floor(Math.random()*msg[1].length)];
					setConnection(address, 5000);
					conTopology.close();
				} else if('getlistnode' == msg[0]) {
					console.log('Нет работающих серверов');
				}
			};

			conTopology.onclose = function(e) {
				console.log('Разорвано соединение с topology');
			};
		}

		function setConnection(address, timeout) {
			conn = new WebSocket('ws://' + address);
			conn.onopen = function(e) {
				console.log("Установленно соединение с " + address);
			};

			conn.onmessage = function(e) {
				console.log(e.data);
			};

			// conn.onerror = function(e) {
			// 	console.log('Ошибка');
			// }

			conn.onclose = function(e) {
				console.log('Соединение не установлено. Переподключение через '+timeout/1000+' сек.');
				setTimeout(setTopologyConnection, timeout, topologyAddress);
			}
		}

		publish.addEventListener('click', publishNews);

		function publishNews() {
			var newsTopic = getTopics(topic);

			var newsText = getNewsText(news);

			var message = {
				'topics': newsTopic,
				'news': newsText
			};

			console.log('Отправил новость: %o', message);

			conn.send( JSON.stringify(message) );
		}

		function getTopics(select) {
			var selectedTopics = [];
			for (var i = 0; i < select.options.length; i++) {
				var option = select.options[i];
				if(option.selected) {
					selectedTopics.push(option.value);
				}
			}
			return selectedTopics;
		}

		function getNewsText(textarea) {
			return textarea.value;
		}
	</script>
</body>
</html>